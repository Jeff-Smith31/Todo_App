AWSTemplateFormatVersion: '2010-09-09'
Description: TickTock Tasks â€” Single EC2 with Elastic IP (frontend+backend via Docker Compose). Route53 apex and API records point directly to the EIP.

Parameters:
  AccountId:
    Type: String
  Region:
    Type: String
  DomainName:
    Type: String
  HostedZoneId:
    Type: String
  VpcId:
    Type: String
  PublicSubnetIdA:
    Type: String
  PublicSubnetIdB:
    Type: String
  InstanceType:
    Type: String
    Default: t3.micro
  ApiSubdomain:
    Type: String
    Default: api
  WwwSubdomain:
    Type: String
    Default: ''
  RepoUrl:
    Type: String
  KeyName:
    Type: String
    Default: ''

Mappings:
  RegionMap:
    us-east-1:
      Ami: ami-0c02fb55956c7d316
    us-east-2:
      Ami: ami-024e6efaf93d85776
    us-west-2:
      Ami: ami-08970fb2e5767e3b8

Resources:
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: EC2 SG allowing HTTP/HTTPS (SSH only if KeyName provided)
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  SshIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: HasKeyName
    Properties:
      GroupId: !Ref InstanceSecurityGroup
      IpProtocol: tcp
      FromPort: 22
      ToPort: 22
      CidrIp: 0.0.0.0/0

  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: CloudWatchLogsAndECRPull
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource: '*'
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref InstanceRole]

  Ec2Instance:
    Type: AWS::EC2::Instance
    Properties:
      IamInstanceProfile: !Ref InstanceProfile
      ImageId: !FindInMap [RegionMap, !Ref AWS::Region, Ami]
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PublicSubnetIdA
      SecurityGroupIds: [!Ref InstanceSecurityGroup]
      KeyName: !If [HasKeyName, !Ref KeyName, !Ref AWS::NoValue]
      Tags:
        - Key: Name
          Value: !Sub 'ttt-app-${DomainName}'
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euxo pipefail
          exec >/var/log/ttt-userdata.log 2>&1
          yum update -y
          amazon-linux-extras install docker -y || true
          yum install -y docker git curl jq
          systemctl enable docker
          systemctl start docker
          curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose
          # App checkout
          mkdir -p /opt/app
          if [ ! -d /opt/app/.git ]; then
            rm -rf /opt/app
            git clone ${RepoUrl} /opt/app
          fi
          cd /opt/app
          # Write compose env
          cat > .env <<EOF
          DOMAIN_NAME=${DomainName}
          CORS_ORIGIN=http://${DomainName},https://${DomainName}
          AWS_REGION=${Region}
          DDB_REGION=${Region}
          EOF
          /usr/local/bin/docker-compose pull || true
          /usr/local/bin/docker-compose up -d

  Eip:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  EipAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt Eip.AllocationId
      InstanceId: !Ref Ec2Instance

  DnsRecordApex:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: A
      TTL: '60'
      ResourceRecords:
        - !GetAtt Eip.PublicIp

  DnsRecordApi:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub '${ApiSubdomain}.${DomainName}'
      Type: A
      TTL: '60'
      ResourceRecords:
        - !GetAtt Eip.PublicIp

  DnsRecordWwwApex:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub 'www.${DomainName}'
      Type: A
      TTL: '60'
      ResourceRecords:
        - !GetAtt Eip.PublicIp

  DnsRecordWwwApi:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub 'www.${ApiSubdomain}.${DomainName}'
      Type: A
      TTL: '60'
      ResourceRecords:
        - !GetAtt Eip.PublicIp

Conditions:
  HasKeyName: !Not [!Equals [!Ref KeyName, ""]]

Outputs:
  PublicIp:
    Value: !Ref Eip
  ApexDomain:
    Value: !Ref DomainName
  ApiDomain:
    Value: !Sub '${ApiSubdomain}.${DomainName}'
  InstanceId:
    Value: !Ref Ec2Instance
